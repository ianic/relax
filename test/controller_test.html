<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>JavaScript unit test file</title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />            
  <link rel="stylesheet" href="../vendor/jsunittest/unittest.css" type="text/css" />    
  
  <script src="../vendor/prototype/prototype.js"     type="text/javascript"></script>        
  <script src="../vendor/jsunittest/jsunittest.js"   type="text/javascript"></script> 
  
  <script src="../vendor/jquery/jquery-1.3.2.min.js" type="text/javascript"></script> 
  <script type="text/javascript" charset="utf-8">
    jQuery.noConflict();
  </script>
  
  <script src="../lib/js_extensions/string.js"       type="text/javascript"></script> 
  <script src="../lib/js_extensions/number.js"       type="text/javascript"></script> 
  <script src="../lib/js_extensions/date.js"         type="text/javascript"></script>                                                                                       
  <script type="text/javascript" charset="utf-8">
    var relax = {     
      debug: false,
    	uiBinder: {},         	
    	logger: {
    	  debug: function(message){
    	    if (relax.debug){
    	      try {console.log(message)} catch(e){};
  	      }
    	  }
    	}
  	};             
  	relax.debug = true;
  </script>                                                                           
  <script src="../lib/relax_helpers.js"              type="text/javascript"></script>
                                                                                          
  <script src="../lib/ui_binder/base_binder.js"      type="text/javascript"></script> 
  <script src="../lib/ui_binder/string_binder.js"    type="text/javascript"></script> 
  <script src="../lib/ui_binder/integer_binder.js"   type="text/javascript"></script> 
  <script src="../lib/ui_binder/date_binder.js"      type="text/javascript"></script> 
  <script src="../lib/ui_binder/currency_binder.js"  type="text/javascript"></script>     
  
  <script src="../lib/controller/base.js"       type="text/javascript"></script>     
  <script src="../lib/controller/template.js"   type="text/javascript"></script>     
  <script src="../lib/controller/formatter.js"  type="text/javascript"></script>       
  
  <script src="../lib/model/base.js"  type="text/javascript"></script>     
    
  <style type="text/css" media="screen">
    .person label {          
      margin-top: 0px;
      display: block;
    }         
    .person input {
      width: 194px;
      margin-bottom: 8px;
    }
    .person .button {
      width: auto;
    }    
    .person { 
      border: dotted 1px;
      padding: 10px 10px 2px 10px;
      width: 200px;
      margin-top: 10px;
      }
  </style>
</head>
<body>
  <div id="content">
    <div id="header">
      <h1>Controller unit tests</h1>
    </div>                                   
    <div id="testlog"> </div>
  </div>     
  
  <div id="container" > </div>
                          
  <div style="display:none;">   
    
    <div id="personTemplate">
      <div class="person">
        <label for="firstname">first name</label><input type="text" property="firstName">
        <label for="firstname">last name</label> <input type="text" property="lastName">  
        <input type="text" property='fullName'> 
        <span property='fullName'></span>
        <div>
          <a action='action1' href='#'>Action 1</a>  
          <input type="button" action='action2' value='Action2' class='button'>          
        </div>
      </div>
    </div>    
    
    <div id="personTemplate2">
      <div style="border: dotted 1px; width:600px; padding:10px; margin-top:10px;">
        <table border="0" cellspacing="4" cellpadding="0">
          <tr>
            <th>first name</th>
            <td><input type="text" property="firstName"> </td>
          </tr>
          <tr>
            <th>last name</th>
            <td><input type="text" property="lastName"> </td>
          </tr>          
          <tr>
            <th>children</th>
            <td>
              <table border="1"> 
                <thead>
                  <tr>
                      <th>Name</th>
                      <th>Age</th>
                  </tr>  
                </thead>
                <tbody children='#'> 
                </tbody>
                <tfoot>
                  <td>sum:</td>
                  <td property="sumChildrenAge">-</td>
                </tfoot>
              </table>
              </table>               
            </td>
          </tr>   
      </div>
    </div>
           
    <table>
      <tbody id="childTemplate">
        <tr>
          <td><input type="text" property='firstName'> </td>
          <td><input type="text" property='age'> </td>
        </tr>
      </tbody>
    </table>
    
  </div>
  
  
  <script type="text/javascript">
  // <![CDATA[    
          
   new Test.Unit.Runner({
     setup: function() { with(this) {    
     }},
       
     teardown: function() { with(this) {
     }},
            
     testTemplateParsing: function() { with(this) {
       var template = new relax.controller.Template('#personTemplate', '#container');             
       assertNotUndefined(template.findProperty('firstName'));
       assertNotUndefined(template.findProperty('lastName'));
       assertNotUndefined(template.findAction('action1'));
       assertNotUndefined(template.findAction('action2'));
       assertUndefined(template.findProperty('pero'));                       
     }}, 
     
     testControllerBinding: function() { with(this) {       
       var model = { 
            firstName: "Pero", 
            lastName: "Zdero", 
            fullName: function(){ return this.firstName + ' ' + this.lastName; },
            setFullName: function(full) { var p = full.split(' '); this.firstName = p[0] || ""; this.lastName = p[1] || ""; }
          };
       relax.model.Base.call(model);
       var controller = new relax.controller.Base('#personTemplate', '#container', model);       
       
       controller.updateElement('firstName', 'Igor')
       assert('Igor', model.name);
       assert('Igor Zdero', model.fullName());
     }}, 
     
     testParentChildControllers: function() { with(this) {
       var model = { 
         firstName: "Igor", 
         lastName: "Anic", 
         children: [
            {firstName: 'Nina', age: 8},
            {firstName: 'Zara', age: 6}
          ],                            
          onChildChanged: function() { 
            this.sumChildrenAge = this.children.inject(0, function(sum, child){ return sum + parseFloat(child.age); }) 
            this.changed();
          },
          sumChildrenAge: 0
         };
       relax.model.Base.call(model);
       
       var controller = new relax.controller.Base('#personTemplate2', '#container', model);
       var childrenRootElement = controller.template.rootElement.find('[children]')
       var childrenControllers = [];
       
       model.children.each(function(child){
         childrenControllers.push(new relax.controller.Base('#childTemplate', childrenRootElement, child));
       });
       
       childrenControllers[0].updateElement('age', 9);
       assertEqual(15, model.sumChildrenAge);
       childrenControllers[1].updateElement('age', 7.5);
       assertEqual(16.5, model.sumChildrenAge);
               
     }},

     


   }, {testLog: "testlog"});
  // ]]>
  </script> 
</body>
</html>